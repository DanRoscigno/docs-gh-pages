<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-multiple">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-KF1LLRTQ5Q"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-KF1LLRTQ5Q",{})</script>


<link rel="search" type="application/opensearchdescription+xml" title="ClickHouse Docs" href="/docs-gh-pages/up/opensearch.xml">



<script src="https://docs-content.clickhouse.tech/docs/js/analytics.js"></script><title data-rh="true">Using multiple primary indexes | ClickHouse Docs</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://path.to.prod.url/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-multiple"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Using multiple primary indexes | ClickHouse Docs"><meta data-rh="true" name="description" content="TODO"><meta data-rh="true" property="og:description" content="TODO"><link data-rh="true" rel="icon" href="/docs-gh-pages/up/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://path.to.prod.url/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-multiple"><link data-rh="true" rel="alternate" href="https://path.to.prod.url/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-multiple" hreflang="en"><link data-rh="true" rel="alternate" href="https://path.to.prod.url/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-multiple" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://62VCH2MD74-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/docs-gh-pages/up/assets/css/styles.e7958b84.css">
<link rel="preload" href="/docs-gh-pages/up/assets/js/runtime~main.2e91e785.js" as="script">
<link rel="preload" href="/docs-gh-pages/up/assets/js/main.b32935ab.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function e(e){document.documentElement.setAttribute("data-theme",e)}var t=function(){var e=null;try{e=localStorage.getItem("theme")}catch(e){}return e}();null!==t?e(t):window.matchMedia("(prefers-color-scheme: dark)").matches?e("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,e("light"))}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top navbarHideable_m1mJ"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a href="https://clickhouse.com/" target="_blank" rel="noopener noreferrer" class="navbar__brand"><div class="navbar__logo"><img src="/docs-gh-pages/up/img/logo_without_text.svg" alt="ClickHouse" class="themedImage_ToTc themedImage--light_HNdA"><img src="/docs-gh-pages/up/img/logo_without_text.svg" alt="ClickHouse" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate">ClickHouse</b></a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Product</a><ul class="dropdown__menu"><li><a href="https://clickhouse.com/cloud" target="_blank" rel="noopener noreferrer" class="dropdown__link">ClickHouse Cloud</a></li><li><a href="https://clickhouse.com/clickhouse" target="_blank" rel="noopener noreferrer" class="dropdown__link">ClickHouse Open Source</a></li></ul></div><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs-gh-pages/up/en/intro">Docs</a><a href="https://clickhouse.com/customer-stories" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Use Cases</a><div class="navbar__item dropdown dropdown--hoverable"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Company</a><ul class="dropdown__menu"><li><a href="https://clickhouse.com/blog" target="_blank" rel="noopener noreferrer" class="dropdown__link">Blog</a></li><li><a href="https://clickhouse.com/company/our-story" target="_blank" rel="noopener noreferrer" class="dropdown__link">Our story</a></li><li><a href="https://clickhouse.com/company/careers" target="_blank" rel="noopener noreferrer" class="dropdown__link">Careers</a></li><li><a href="https://clickhouse.com/company/contact" target="_blank" rel="noopener noreferrer" class="dropdown__link">Contact us</a></li><li><a href="https://clickhouse.com/company/news-events" target="_blank" rel="noopener noreferrer" class="dropdown__link">News and events</a></li></ul></div></div><div class="navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Language</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs-gh-pages/up/en/intro">English</a></li><li><a class="dropdown__link" href="/docs-gh-pages/up/ru">Russian</a></li><li><a class="dropdown__link" href="/docs-gh-pages/up/zh">Chinese</a></li></ul></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd sidebarWithHideableNavbar_wUlq"><a href="https://clickhouse.com/" target="_blank" rel="noopener noreferrer" tabindex="-1" class="sidebarLogo_isFc"><img src="/docs-gh-pages/up/img/logo_without_text.svg" alt="ClickHouse" class="themedImage_ToTc themedImage--light_HNdA"><img src="/docs-gh-pages/up/img/logo_without_text.svg" alt="ClickHouse" class="themedImage_ToTc themedImage--dark_i4oU"><b>ClickHouse</b></a><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs-gh-pages/up/en/intro">What is ClickHouse?</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs-gh-pages/up/en/quick-start">Quick Start</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/docs-gh-pages/up/en/tutorial">Tutorial</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs-gh-pages/up/en/getting-started/example-datasets">Example Datasets</a><button aria-label="Toggle the collapsible sidebar category &#x27;Example Datasets&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs-gh-pages/up/en/integrations">Integrations</a><button aria-label="Toggle the collapsible sidebar category &#x27;Integrations&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs-gh-pages/up/en/connect-a-ui">Connect a UI</a><button aria-label="Toggle the collapsible sidebar category &#x27;Connect a UI&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs-gh-pages/up/en/guides">User Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;User Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs-gh-pages/up/en/guides/developer">Developer Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developer Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs-gh-pages/up/en/guides/sre">SRE Guides</a><button aria-label="Toggle the collapsible sidebar category &#x27;SRE Guides&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs-gh-pages/up/en/guides/improving-query-performance">Improving Query Performance</a><button aria-label="Toggle the collapsible sidebar category &#x27;Improving Query Performance&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs-gh-pages/up/en/guides/improving-query-performance/skipping-indexes">Data Skipping Indexes</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" tabindex="0" href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes">Sparse Primary Indexes</a><button aria-label="Toggle the collapsible sidebar category &#x27;Sparse Primary Indexes&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-intro">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design">ClickHouse Index Design</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-multiple">Using multiple primary indexes</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-cardinality">Ordering key columns efficiently</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-uuids">Identifying single rows efficiently</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" tabindex="0" href="/docs-gh-pages/up/en/guides/ingest">Ingest</a><button aria-label="Toggle the collapsible sidebar category &#x27;Ingest&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs-gh-pages/up/category/reference">Reference</a><button aria-label="Toggle the collapsible sidebar category &#x27;Reference&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs-gh-pages/up/en/faq">FAQ</a><button aria-label="Toggle the collapsible sidebar category &#x27;FAQ&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs-gh-pages/up/en/whats-new">What&#x27;s New</a><button aria-label="Toggle the collapsible sidebar category &#x27;What&#x27;s New&#x27;" type="button" class="clean-btn menu__caret"></button></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist" aria-expanded="false" href="/docs-gh-pages/up/en/about-us">About Us</a><button aria-label="Toggle the collapsible sidebar category &#x27;About Us&#x27;" type="button" class="clean-btn menu__caret"></button></div></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs-gh-pages/up/en/guides"><span itemprop="name">User Guides</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs-gh-pages/up/en/guides/improving-query-performance"><span itemprop="name">Improving Query Performance</span></a><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes"><span itemprop="name">Sparse Primary Indexes</span></a><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Using multiple primary indexes</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Using multiple primary indexes</h1><a name="filtering-on-key-columns-after-the-first"></a><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="secondary-key-columns-can-not-be-inefficient">Secondary key columns can (not) be inefficient<a class="hash-link" href="#secondary-key-columns-can-not-be-inefficient" title="Direct link to heading">​</a></h2><p>When a query is filtering on a column that is part of a compound key and is the first key column, <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#the-primary-index-is-used-for-selecting-granules">then ClickHouse is running the binary search algorithm over the key column&#x27;s index marks</a>.</p><p>But what happens when a query is filtering on a column that is part of a compound key, but is not the first key column?</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>We discuss a scenario when a query is explicitly not filtering on the first key colum, but on a secondary key column.</p><p>When a query is filtering on both the first key column and on any key column(s) after the first then ClickHouse is running binary search over the first key column&#x27;s index marks.</p></div></div><br><br><a name="query-on-url"></a>We use a query that calculates the top 10 users that have most frequently clicked on the URL &quot;http://public_search&quot;:<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">SELECT</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">count</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">AS</span><span class="token plain"> Count</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">FROM</span><span class="token plain"> hits_UserID_URL</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">WHERE</span><span class="token plain"> URL </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;http://public_search&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> UserID</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> Count </span><span class="token keyword" style="color:rgb(0, 0, 255)">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response is: <a name="query-on-url-slow"></a></p><div class="language-response codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">┌─────UserID─┬─Count─┐</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 2459550954 │  3741 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 1084649151 │  2484 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│  723361875 │   729 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 3087145896 │   695 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 2754931092 │   672 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 1509037307 │   582 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 3085460200 │   573 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 2454360090 │   556 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 3884990840 │   539 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│  765730816 │   536 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">└────────────┴───────┘</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">10 rows in set. Elapsed: 0.086 sec.</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#000000"><span class="token plain">Processed 8.81 million rows,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">799.69 MB (102.11 million rows/s., 9.27 GB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The client output indicates that ClickHouse almost executed a full table scan despite the <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#a-table-with-a-primary-key">URL column being part of the compound primary key</a>! ClickHouse reads 8.81 million rows from the 8.87 million rows of the table.</p><p>If <a href="https://clickhouse.com/docs/en/operations/server-configuration-parameters/settings/#server_configuration_parameters-logger" target="_blank" rel="noopener noreferrer">trace logging</a> is enabled then the ClickHouse server log file shows that ClickHouse used a <a href="https://github.com/ClickHouse/ClickHouse/blob/22.3/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp#L1444" target="_blank" rel="noopener noreferrer">generic exclusion search</a> over the 1083 URL index marks in order to identify those granules that possibly can contain rows with a URL column value of &quot;http://public_search&quot;:</p><div class="language-response codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">...Executor): Key condition: (column 1 in [&#x27;http://public_search&#x27;,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                           &#x27;http://public_search&#x27;])</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#000000"><span class="token plain">...Executor): Used generic exclusion search over index for part all_1_9_2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              with 1537 steps</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">...Executor): Selected 1/1 parts by partition key, 1 parts by primary key,</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#000000"><span class="token plain">              1076/1083 marks by primary key, 1076 marks to read from 5 ranges</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">...Executor): Reading approx. 8814592 rows with 10 streams</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>We can see in the sample trace log above, that 1076 (via the marks) out of 1083 granules were selected as possibly containing rows with a matching URL value.</p><p>This results in 8.81 million rows being streamed into the ClickHouse engine (in parallel by using 10 streams), in order to identify the rows that are actually contain the URL value &quot;http://public_search&quot;.</p><p>However, <a href="#query-on-url-fast">as we will see later</a> only 39 granules out of that selected 1076 granules actually contain matching rows.</p><p>Whilst the primary index based on the compound primary key (UserID, URL) was very useful for speeding up queries filtering for rows with a specific UserID value, the index is not providing significant help with speeding up the query that filters for rows with a specific URL value.</p><p>The reason for this is that the URL column is not the first key column and therefore ClickHouse is using a generic exclusion search algorithm (instead of binary search) over the URL column&#x27;s index marks, and <strong>the effectiveness of that algorithm is dependant on the cardinality difference</strong> between the URL column and it&#x27;s predecessor key column UserID.</p><p>In order to illustrate that, we give some details about how the generic exclusion search works.</p><a name="generic-exclusion-search-algorithm"></a><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="generic-exclusion-search-algorithm">Generic exclusion search algorithm<a class="hash-link" href="#generic-exclusion-search-algorithm" title="Direct link to heading">​</a></h2><p>The following is illustrating how the <a href="https://github.com/ClickHouse/ClickHouse/blob/22.3/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp#L14444" target="_blank" rel="noopener noreferrer">ClickHouse generic exclusion search algorithm</a> works when granules are selected via a secondary column where the predecessor key column has a low(er) or high(er) cardinality.</p><p>As an example for both cases we will assume:</p><ul><li>a query that is searching for rows with URL value = &quot;W3&quot;.</li><li>an abstract version of our hits table with simplified values for UserID and URL.</li><li>the same compound primary key (UserID, URL) for the index. This means rows are first ordered by UserID values. Rows with the same UserID value are then ordered by URL.</li><li>a granule size of two i.e. each granule contains two rows.</li></ul><p>We have marked the minimum key column values for each granule in orange in the diagrams below..</p><p><strong>Predecessor key column has low(er) cardinality</strong><a name="generic-exclusion-search-fast"></a></p><p>Suppose UserID had low cardinality. In this case it would be likely that the same UserID value is spread over multiple table rows and granules and therefore index marks. For index marks with the same UserID, the URL values for the index marks are sorted in ascending order (because the table rows are ordered first by UserID and then by URL). This allows efficient filtering as described below:</p><img loading="lazy" src="/docs-gh-pages/up/assets/images/sparse-primary-indexes-07-ca969e10017e98b0bbc54d7d12e015ce.png" class="image" class="img_ev3q"><p>There are three different scenarios for the granule selection process for our abstract sample data in the diagram above:</p><ol><li><p>Index mark 0 for which the (minimum) <strong>URL value is smaller than W3 and for which the URL value of the directly succeeding index mark is also smaller than W3</strong> can be excluded because mark 0, 1, and 2 have the same UserID value. Note that this exclusion-precondition ensures that granule 0 and the next granule 1 are completely composed of U1 UserID values so that ClickHouse can assume that also the maximum URL value in granule 0 is smaller than W3 and exclude the granule.</p></li><li><p>Index mark 1 for which the <strong>URL value is smaller (or equal) than W3 and for which the URL value of the directly succeeding index mark is greater (or equal) than W3</strong> is selected because it means that granule 1 can possibly contain rows with URL W3).</p></li><li><p>Index marks 2 and 3 for which the <strong>URL value is greater than W3</strong> can be excluded, since index marks of a primary index store the minimum key column values for each granule and therefore granule 2 and 3 can&#x27;t possibly contain URL value W3.</p></li></ol><p><strong>Predecessor key column has high(er) cardinality</strong><a name="generic-exclusion-search-slow"></a></p><p>When the UserID has high cardinality then it is unlikely that the same UserID value is spread over multiple table rows and granules. This means the URL values for the index marks are not monotonically increasing:</p><img loading="lazy" src="/docs-gh-pages/up/assets/images/sparse-primary-indexes-08-54c7f76e3fb20ebf6b43f39070bc700d.png" class="image" class="img_ev3q"><p>As we can see in the diagram above, all shown marks whose URL values are smaller than W3 are getting selected for streaming its associated granule&#x27;s rows into the ClickHouse engine.</p><p>This is because whilst all index marks in the diagram fall into scenario 1 described above, they do not satisfy the mentioned exclusion-precondition that <em>the two directly succeeding index marks both have the same UserID value as the current mark</em> and thus can’t be excluded.</p><p>For example, consider index mark 0 for which the <strong>URL value is smaller than W3 and for which the URL value of the directly succeeding index mark is also smaller than W3</strong>. This can <em>not</em> be excluded because the two directly succeeding index marks 1 and 2 do <em>not</em> have the same UserID value as the current mark 0.</p><p>Note the requirement for the two succeeding index marks to have the same UserID value. This ensures that the granules for the current and the next mark are completely composed of U1 UserID values. If only the next mark had the same UserID, the URL value of the next mark could potentially stem from a table row with a different UserID - which is indeed the case when you look at the diagram above i.e. W2 stems from a row with U2 not U1.</p><p>This ultimately prevents ClickHouse from making assumptions about the maximum URL value in granule 0. Instead it has to assume that granule 0 potentially contains rows with URL value W3 and is forced to select mark 0.</p><br><p>The same scenario is true for mark 1, 2, and 3.</p><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>Conclusion</h5></div><div class="admonition-content"><p>The <a href="https://github.com/ClickHouse/ClickHouse/blob/22.3/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp#L1444" target="_blank" rel="noopener noreferrer"><font color="blue">generic exclusion search algorithm</font></a> that ClickHouse is using instead of the <a href="https://github.com/ClickHouse/ClickHouse/blob/22.3/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp#L1452" target="_blank" rel="noopener noreferrer"><font color="blue">binary search algorithm</font></a> when a query is filtering on a column that is part of a compound key, but is not the first key column is most effective when the predecessor key column has low(er) cardinality.</p></div></div><p>In our sample data set both key columns (UserID, URL) have similar high cardinality, and, as explained, the generic exclusion search algorithm is not very effective when the predecessor key column of the URL column has a high(er) or similar cardinality.</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="note-about-data-skipping-index">Note about data skipping index<a class="hash-link" href="#note-about-data-skipping-index" title="Direct link to heading">​</a></h2><p>Because of the similarly high cardinality of UserID and URL, our <a href="#query-on-url"><font>query filtering on URL</font></a> also wouldn&#x27;t benefit much from creating a <a href="/docs-gh-pages/up/en/guides/improving-query-performance/skipping-indexes"><font>secondary data skipping index</font></a> on the URL column
of our <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#a-table-with-a-primary-key"><font>table with compound primary key (UserID, URL)</font></a>.</p><p>For example this two statements create and populate a <a href="https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/#primary-keys-and-indexes-in-queries" target="_blank" rel="noopener noreferrer"><font>minmax</font></a> data skipping index on the URL column of our table:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> hits_UserID_URL </span><span class="token keyword" style="color:rgb(0, 0, 255)">ADD</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">INDEX</span><span class="token plain"> url_skipping_index URL </span><span class="token keyword" style="color:rgb(0, 0, 255)">TYPE</span><span class="token plain"> minmax GRANULARITY </span><span class="token number" style="color:rgb(9, 134, 88)">4</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> hits_UserID_URL MATERIALIZE </span><span class="token keyword" style="color:rgb(0, 0, 255)">INDEX</span><span class="token plain"> url_skipping_index</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ClickHouse now created an additional index that is storing - per group of 4 consecutive <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#data-is-organized-into-granules-for-parallel-data-processing"><font>granules</font></a> (note the <font face="monospace">GRANULARITY 4</font> clause in the <font face="monospace">ALTER TABLE</font> statement above) - the minimum and maximum URL value:</p><img loading="lazy" src="/docs-gh-pages/up/assets/images/sparse-primary-indexes-13a-bb454960e2aee77973232e65468a19a6.png" class="image" class="img_ev3q"><p>The first index entry (‘mark 0’ in the diagram above) is storing the minimum and maximum URL values for the <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#data-is-organized-into-granules-for-parallel-data-processing"><font>rows belonging to the first 4 granules of our table</font></a>.</p><p>The second index entry (‘mark 1’) is storing the minimum and maximum URL values for the rows belonging to the next 4 granules of our table, and so on.</p><p>(ClickHouse also created a special <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#mark-files-are-used-for-locating-granules"><font>mark file</font></a> for to the data skipping index for <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#mark-files-are-used-for-locating-granules"><font>locating</font></a> the groups of granules associated with the index marks.)</p><p>Because of the similarly high cardinality of UserID and URL, this secondary data skipping index can&#x27;t help with excluding granules from being selected when our <a href="#query-on-url"><font>query filtering on URL</font></a> is executed.</p><p>The specific URL value that the query is looking for (i.e. &#x27;http://public_search&#x27;) very likely is between the minimum and maximum value stored by the index for each group of granules resulting in ClickHouse being forced to select the group of granules (because they might contain row(s) matching the query).</p><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="a-need-to-use-multiple-primary-indexes">A need to use multiple primary indexes<a class="hash-link" href="#a-need-to-use-multiple-primary-indexes" title="Direct link to heading">​</a></h2><p>As a consequence, if we want to significantly speed up our sample query that filters for rows with a specific URL then we need to use a primary index optimized to that query.</p><p>If in addition we want to keep the good performance of our sample query that filters for rows with a specific UserID then we need to use multiple primary indexes.</p><p>The following is showing ways for achieving that.</p><a name="multiple-primary-indexes"></a><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="options-for-creating-additional-primary-indexes">Options for creating additional primary indexes<a class="hash-link" href="#options-for-creating-additional-primary-indexes" title="Direct link to heading">​</a></h2><p>If we want to significantly speed up both of our sample queries - the one that  filters for rows with a specific UserID and the one that filters for rows with a specific URL - then we need to use multiple primary indexes by using one if these three options:</p><ul><li>Creating a <strong>second table</strong> with a different primary key.</li><li>Creating a <strong>materialized view</strong> on our existing table.</li><li>Adding a <strong>projection</strong> to our existing table.</li></ul><p>All three options will effectively duplicate our sample data into a additional table in order to reorganize the table primary index and row sort order.</p><p>However, the three options differ in how transparent that additional table is to the user with respect to the routing of queries and insert statements.</p><p>When creating a <strong>second table</strong> with a different primary key then queries must be explicitly send to the table version best suited for the query, and new data must be inserted explicitly into both tables in order to keep the tables in sync:</p><img loading="lazy" src="/docs-gh-pages/up/assets/images/sparse-primary-indexes-09a-003957a1db28ae299e76de115d417152.png" class="image" class="img_ev3q"><p>With a <strong>materialized view</strong> the additional table is implicitly created and data is automatically kept in sync between both tables:</p><img loading="lazy" src="/docs-gh-pages/up/assets/images/sparse-primary-indexes-09b-0a3561fdefc32a8186cd253bd350ee1e.png" class="image" class="img_ev3q"><p>And the <strong>projection</strong> is the most transparent option because next to automatically keeping the implicitly created (and hidden) additional table in sync with data changes, ClickHouse will automatically choose the most effective table version for queries:</p><img loading="lazy" src="/docs-gh-pages/up/assets/images/sparse-primary-indexes-09c-f119a3e25f91776b8afb3f5c637435e4.png" class="image" class="img_ev3q"><p>In the following we discuss this three options for creating and using multiple primary indexes in more detail and with real examples.</p><a name="multiple-primary-indexes-via-secondary-tables"></a><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="option-1-secondary-tables">Option 1: Secondary Tables<a class="hash-link" href="#option-1-secondary-tables" title="Direct link to heading">​</a></h2><a name="secondary-table"></a>We are creating a new additional table where we switch the order of the key columns (compared to our original table) in the primary key:<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> hits_URL_UserID</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(4, 81, 165)">`</span><span class="token identifier">UserID</span><span class="token identifier punctuation" style="color:rgb(4, 81, 165)">`</span><span class="token plain"> UInt32</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(4, 81, 165)">`</span><span class="token identifier">URL</span><span class="token identifier punctuation" style="color:rgb(4, 81, 165)">`</span><span class="token plain"> String</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token identifier punctuation" style="color:rgb(4, 81, 165)">`</span><span class="token identifier">EventTime</span><span class="token identifier punctuation" style="color:rgb(4, 81, 165)">`</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">DateTime</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> MergeTree</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">URL</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">URL</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> EventTime</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">SETTINGS index_granularity </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">8192</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> index_granularity_bytes </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">0</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Insert all 8.87 million rows from our <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#a-table-with-a-primary-key">original table</a> into the additional table:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">INSERT</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">INTO</span><span class="token plain"> hits_URL_UserID</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">from</span><span class="token plain"> hits_UserID_URL</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response looks like:</p><div class="language-response codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">Ok.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0 rows in set. Elapsed: 2.898 sec. Processed 8.87 million rows, 838.84 MB (3.06 million rows/s., 289.46 MB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And finally optimize the table:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">OPTIMIZE</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> hits_URL_UserID FINAL</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Because we switched the order of the columns in the primary key, the inserted rows are now stored on disk in a different lexicographical order (compared to our <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#a-table-with-a-primary-key">original table</a>) and therefore also the 1083 granules of that table are containing different values than before:</p><img loading="lazy" src="/docs-gh-pages/up/assets/images/sparse-primary-indexes-10-5004790259b0e01501b4d6cb134cf89b.png" class="image" class="img_ev3q"><p>This is the resulting primary key:</p><img loading="lazy" src="/docs-gh-pages/up/assets/images/sparse-primary-indexes-11-ab890a1c2452311841344927ae544e05.png" class="image" class="img_ev3q"><p>That can now be used to significantly speed up the execution of our example query filtering on the URL column in order to calculate the top 10 users that most frequently clicked on the URL &quot;http://public_search&quot;:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">SELECT</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">count</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">AS</span><span class="token plain"> Count</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">FROM</span><span class="token plain"> hits_URL_UserID</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">WHERE</span><span class="token plain"> URL </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;http://public_search&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> UserID</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> Count </span><span class="token keyword" style="color:rgb(0, 0, 255)">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response is:</p><a name="query-on-url-fast"></a><div class="language-response codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">┌─────UserID─┬─Count─┐</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 2459550954 │  3741 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 1084649151 │  2484 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│  723361875 │   729 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 3087145896 │   695 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 2754931092 │   672 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 1509037307 │   582 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 3085460200 │   573 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 2454360090 │   556 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 3884990840 │   539 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│  765730816 │   536 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">└────────────┴───────┘</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">10 rows in set. Elapsed: 0.017 sec.</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#000000"><span class="token plain">Processed 319.49 thousand rows,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">11.38 MB (18.41 million rows/s., 655.75 MB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Now, instead of <a href="#filtering-on-key-columns-after-the-first">almost doing a full table scan</a>, ClickHouse executed that query much more effectively.</p><p>With the primary index from the <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#a-table-with-a-primary-key">original table</a> where UserID was the first, and URL the second key column, ClickHouse used a <a href="#generic-exclusion-search-algorithm">generic exclusion search</a> over the index marks for executing that query and that was not very effective because of the similarly high cardinality of UserID and URL.</p><p>With URL as the first column in the primary index, ClickHouse is now running <a href="https://github.com/ClickHouse/ClickHouse/blob/22.3/src/Storages/MergeTree/MergeTreeDataSelectExecutor.cpp#L1452" target="_blank" rel="noopener noreferrer">binary search</a> over the index marks.
The corresponding trace log in the ClickHouse server log file confirms that:</p><div class="language-response codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">...Executor): Key condition: (column 0 in [&#x27;http://public_search&#x27;,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                           &#x27;http://public_search&#x27;])</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#000000"><span class="token plain">...Executor): Running binary search on index range for part all_1_9_2 (1083 marks)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">...Executor): Found (LEFT) boundary mark: 644</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">...Executor): Found (RIGHT) boundary mark: 683</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">...Executor): Found continuous range in 19 steps</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">...Executor): Selected 1/1 parts by partition key, 1 parts by primary key,</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#000000"><span class="token plain">              39/1083 marks by primary key, 39 marks to read from 1 ranges</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">...Executor): Reading approx. 319488 rows with 2 streams</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ClickHouse selected only 39 index marks, instead of 1076 when generic exclusion search was used.</p><p>Note that the additional table is optimized for speeding up the execution of our example query filtering on URLs.</p><p>Similar to the <a href="#query-on-url-slow">bad performance</a> of that query with our <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#a-table-with-a-primary-key">original table</a>, our <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#the-primary-index-is-used-for-selecting-granules">example query filtering on UserIDs</a> will not run very effectively with the new additional table, because UserID is now the second key column in the primary index of that table and therefore ClickHouse will use generic exclusion search for granule selection, which is <a href="#generic-exclusion-search-slow">not very effective for similarly high cardinality</a> of UserID and URL.
Open the details box for specifics.</p><details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary><font color="black">Query filtering on UserIDs now has bad performance<a name="query-on-userid-slow"></a></font></summary><div><div class="collapsibleContent_i85q"><p><font color="black"><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">SELECT</span><span class="token plain"> URL</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">count</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">URL</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">AS</span><span class="token plain"> Count</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">FROM</span><span class="token plain"> hits_URL_UserID</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">WHERE</span><span class="token plain"> UserID </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">749927693</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> URL</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> Count </span><span class="token keyword" style="color:rgb(0, 0, 255)">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response is:</p><div class="language-response codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">┌─URL────────────────────────────┬─Count─┐</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ http://auto.ru/chatay-barana.. │   170 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ http://auto.ru/chatay-id=371...│    52 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ http://public_search           │    45 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ http://kovrik-medvedevushku-...│    36 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ http://forumal                 │    33 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ http://korablitz.ru/L_1OFFER...│    14 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ http://auto.ru/chatay-id=371...│    14 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ http://auto.ru/chatay-john-D...│    13 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ http://auto.ru/chatay-john-D...│    10 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ http://wot/html?page/23600_m...│     9 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">└────────────────────────────────┴───────┘</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">10 rows in set. Elapsed: 0.024 sec.</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#000000"><span class="token plain">Processed 8.02 million rows,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">73.04 MB (340.26 million rows/s., 3.10 GB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Server Log:</p><div class="language-response codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">...Executor): Key condition: (column 1 in [749927693, 749927693])</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#000000"><span class="token plain">...Executor): Used generic exclusion search over index for part all_1_9_2</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">              with 1453 steps</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">...Executor): Selected 1/1 parts by partition key, 1 parts by primary key,</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#000000"><span class="token plain">              980/1083 marks by primary key, 980 marks to read from 23 ranges</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">...Executor): Reading approx. 8028160 rows with 10 streams</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></font></p></div></div></details><p>We now have two tables. Optimized for speeding up queries filtering on UserIDs, and speeding up queries filtering on URLs, respectively:</p><img loading="lazy" src="/docs-gh-pages/up/assets/images/sparse-primary-indexes-12a-54e3db82bfbb418a37bd38c6b1f404cf.png" class="image" class="img_ev3q"><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="option-2-materialized-views">Option 2: Materialized Views<a class="hash-link" href="#option-2-materialized-views" title="Direct link to heading">​</a></h2><p>Create a <a href="https://clickhouse.com/docs/en/sql-reference/statements/create/view/#materialized" target="_blank" rel="noopener noreferrer">materialized view</a> on our existing table.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">CREATE</span><span class="token plain"> MATERIALIZED </span><span class="token keyword" style="color:rgb(0, 0, 255)">VIEW</span><span class="token plain"> mv_hits_URL_UserID</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ENGINE</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> MergeTree</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">URL</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">URL</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> EventTime</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">POPULATE</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">AS</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">*</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">FROM</span><span class="token plain"> hits_UserID_URL</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response looks like:</p><div class="language-response codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">Ok.</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">0 rows in set. Elapsed: 2.935 sec. Processed 8.87 million rows, 838.84 MB (3.02 million rows/s., 285.84 MB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><ul><li>we switch the order of the key columns (compared to our <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#a-table-with-a-primary-key"><font color="blue">original table</font></a> ) in the view&#x27;s primary key</li><li>the materialized view is backed by a <strong>implicitly created table</strong> whose row order and primary index is based on the given primary key definition</li><li>the implicitly created table is listed by the <font face="monospace">SHOW TABLES</font> query and has a name starting with <font face="monospace">.inner</font></li><li>it is also possible to first explicitly create the backing table for a materialized view and then the view can target that table via the <font face="monospace">TO <!-- -->[db]<!-- -->.<!-- -->[table]</font> <a href="https://clickhouse.com/docs/en/sql-reference/statements/create/view/#materialized" target="_blank" rel="noopener noreferrer"><font color="blue">clause</font></a></li><li>we use the <font face="monospace">POPULATE</font> keyword in order to immediately populate the implicitly created table with all 8.87 million rows from the source table <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#a-table-with-a-primary-key"><font color="blue">hits_UserID_URL</font></a></li><li>if new rows are inserted into the source table hits_UserID_URL, then that rows are automatically also inserted into the implicitly created table</li><li>Effectively the implicitly created table has the same row order and primary index as the <a href="#multiple-primary-indexes-via-secondary-tables"><font color="blue">secondary table that we created explicitly</font></a>:</li></ul><img loading="lazy" src="/docs-gh-pages/up/assets/images/sparse-primary-indexes-12b-1-1714fbeed96c5c00dc5e0118f0ce7232.png" class="image" class="img_ev3q"><p>ClickHouse is storing the <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#data-is-stored-on-disk-ordered-by-primary-key-columns"><font color="blue">column data files</font></a> (<em>.bin), the <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#mark-files-are-used-for-locating-granules"><font color="blue">mark files</font></a> (</em>.mrk2) and the <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#the-primary-index-has-one-entry-per-granule"><font color="blue">primary index</font></a> (primary.idx) of the implicitly created table in a special folder withing the ClickHouse server&#x27;s data directory:</p><img loading="lazy" src="/docs-gh-pages/up/assets/images/sparse-primary-indexes-12b-2-f0fe4fee1e1c4e9e46097ecaa4ae0313.png" class="image" class="img_ev3q"></div></div><p>The implicitly created table (and it&#x27;s primary index) backing the materialized view can now be used to significantly speed up the execution of our example query filtering on the URL column:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">SELECT</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">count</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">AS</span><span class="token plain"> Count</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">FROM</span><span class="token plain"> mv_hits_URL_UserID</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">WHERE</span><span class="token plain"> URL </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;http://public_search&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> UserID</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> Count </span><span class="token keyword" style="color:rgb(0, 0, 255)">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response is:</p><div class="language-response codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">┌─────UserID─┬─Count─┐</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 2459550954 │  3741 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 1084649151 │  2484 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│  723361875 │   729 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 3087145896 │   695 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 2754931092 │   672 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 1509037307 │   582 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 3085460200 │   573 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 2454360090 │   556 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 3884990840 │   539 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│  765730816 │   536 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">└────────────┴───────┘</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">10 rows in set. Elapsed: 0.026 sec.</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#000000"><span class="token plain">Processed 335.87 thousand rows,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">13.54 MB (12.91 million rows/s., 520.38 MB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Because effectively the implicitly created table (and it&#x27;s primary index) backing the materialized view is identical to the <a href="#multiple-primary-indexes-via-secondary-tables"><font color="blue">secondary table that we created explicitly</font></a>, the query is executed in the same effective way as with the explicitly created table.</p><p>The corresponding trace log in the ClickHouse server log file confirms that ClickHouse is running binary search over the index marks:</p><div class="language-response codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">...Executor): Key condition: (column 0 in [&#x27;http://public_search&#x27;,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                           &#x27;http://public_search&#x27;])</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#000000"><span class="token plain">...Executor): Running binary search on index range ...</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">...</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">...Executor): Selected 4/4 parts by partition key, 4 parts by primary key,</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#000000"><span class="token plain">              41/1083 marks by primary key, 41 marks to read from 4 ranges</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">...Executor): Reading approx. 335872 rows with 4 streams</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="option-3-projections">Option 3: Projections<a class="hash-link" href="#option-3-projections" title="Direct link to heading">​</a></h2><a href="https://clickhouse.com/docs/en/engines/table-engines/mergetree-family/mergetree/#projections" target="_blank" rel="noopener noreferrer">Projections</a> are an experimental feature at the moment, therefore we need to tell ClickHouse that we know what we are doing first:<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">SET</span><span class="token plain"> allow_experimental_projection_optimization </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">1</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Create a projection on our existing table:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> hits_UserID_URL</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token keyword" style="color:rgb(0, 0, 255)">ADD</span><span class="token plain"> PROJECTION prj_url_userid</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token keyword" style="color:rgb(0, 0, 255)">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:rgb(0, 0, 0)">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">        </span><span class="token keyword" style="color:rgb(0, 0, 255)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">URL</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>And materialize the projection:</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">TABLE</span><span class="token plain"> hits_UserID_URL</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">    MATERIALIZE PROJECTION prj_url_userid</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><ul><li>the projection is creating a <strong>hidden table</strong> whose row order and primary index is based on the given <font face="monospace">ORDER BY</font> clause of the projection</li><li>the hidden table is not listed by the <font face="monospace">SHOW TABLES</font> query</li><li>we use the <font face="monospace">MATERIALIZE</font> keyword in order to immediately populate the hidden table with all 8.87 million rows from the source table <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#a-table-with-a-primary-key"><font color="blue">hits_UserID_URL</font></a></li><li>if new rows are inserted into the source table hits_UserID_URL, then that rows are automatically also inserted into the hidden table</li><li>a query is always (syntactically) targeting the source table hits_UserID_URL, but if the row order and primary index of the hidden table allows a more effective query execution, then that hidden table will be used instead</li><li>Effectively the implicitly created hidden table has the same row order and primary index as the <a href="#multiple-primary-indexes-via-secondary-tables"><font color="blue">secondary table that we created explicitly</font></a>:</li></ul><img loading="lazy" src="/docs-gh-pages/up/assets/images/sparse-primary-indexes-12c-1-90b8028f1ac3927bec9fc9b0d0763ac9.png" class="image" class="img_ev3q"><p>ClickHouse is storing the <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#data-is-stored-on-disk-ordered-by-primary-key-columns"><font color="blue">column data files</font></a> (<em>.bin), the <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#mark-files-are-used-for-locating-granules"><font color="blue">mark files</font></a> (</em>.mrk2) and the <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#the-primary-index-has-one-entry-per-granule"><font color="blue">primary index</font></a> (primary.idx) of the hidden table in a special folder (marked in orange in the screenshot below) next to the source table&#x27;s data files, mark files, and primary index files:</p><img loading="lazy" src="/docs-gh-pages/up/assets/images/sparse-primary-indexes-12c-2-197ed8132c0d6c239074af1ea1bb094e.png" class="image" class="img_ev3q"></div></div><p>The hidden table (and it&#x27;s primary index) created by the projection can now be (implicitly) used to significantly speed up the execution of our example query filtering on the URL column. Note that the query is syntactically targeting the source table of the projection.</p><div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token keyword" style="color:rgb(0, 0, 255)">SELECT</span><span class="token plain"> UserID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">,</span><span class="token plain"> </span><span class="token function" style="color:rgb(0, 0, 255)">count</span><span class="token punctuation" style="color:rgb(4, 81, 165)">(</span><span class="token plain">UserID</span><span class="token punctuation" style="color:rgb(4, 81, 165)">)</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">AS</span><span class="token plain"> Count</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">FROM</span><span class="token plain"> hits_UserID_URL</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">WHERE</span><span class="token plain"> URL </span><span class="token operator" style="color:rgb(0, 0, 0)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(163, 21, 21)">&#x27;http://public_search&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> UserID</span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:rgb(0, 0, 255)">BY</span><span class="token plain"> Count </span><span class="token keyword" style="color:rgb(0, 0, 255)">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain"></span><span class="token keyword" style="color:rgb(0, 0, 255)">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:rgb(9, 134, 88)">10</span><span class="token punctuation" style="color:rgb(4, 81, 165)">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The response is:</p><div class="language-response codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">┌─────UserID─┬─Count─┐</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 2459550954 │  3741 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 1084649151 │  2484 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│  723361875 │   729 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 3087145896 │   695 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 2754931092 │   672 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 1509037307 │   582 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 3085460200 │   573 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 2454360090 │   556 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│ 3884990840 │   539 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">│  765730816 │   536 │</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">└────────────┴───────┘</span><br></span><span class="token-line" style="color:#000000"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#000000"><span class="token plain">10 rows in set. Elapsed: 0.029 sec.</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#000000"><span class="token plain">Processed 319.49 thousand rows, 1</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">1.38 MB (11.05 million rows/s., 393.58 MB/s.)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Because effectively the hidden table (and it&#x27;s primary index) created by the projection is identical to the <a href="#multiple-primary-indexes-via-secondary-tables"><font color="blue">secondary table that we created explicitly</font></a>, the query is executed in the same effective way as with the explicitly created table.</p><p>The corresponding trace log in the ClickHouse server log file confirms that ClickHouse is running binary search over the index marks:</p><div class="language-response codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#000000;--prism-background-color:#ffffff"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-response codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#000000"><span class="token plain">...Executor): Key condition: (column 0 in [&#x27;http://public_search&#x27;,</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">                                           &#x27;http://public_search&#x27;])</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#000000"><span class="token plain">...Executor): Running binary search on index range for part prj_url_userid (1083 marks)</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">...Executor): ...</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#000000"><span class="token plain">...Executor): Choose complete Normal projection prj_url_userid</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">...Executor): projection required columns: URL, UserID</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">...Executor): Selected 1/1 parts by partition key, 1 parts by primary key,</span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#000000"><span class="token plain">              39/1083 marks by primary key, 39 marks to read from 1 ranges</span><br></span><span class="token-line" style="color:#000000"><span class="token plain">...Executor): Reading approx. 319488 rows with 2 streams</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithHideOnScrollNavbar_WYt5" id="summary">Summary<a class="hash-link" href="#summary" title="Direct link to heading">​</a></h2><p>The primary index of our <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#a-table-with-a-primary-key">table with compound primary key (UserID, URL)</a> was very useful for speeding up a <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#the-primary-index-is-used-for-selecting-granules">query filtering on UserID</a>. But that index is not providing significant help with speeding up a <a href="#query-on-url">query filtering on URL</a>, despite the URL column being part of the compound primary key.</p><p>And vice versa:
The primary index of our <a href="#secondary-table">table with compound primary key (URL, UserID)</a> was speeding up a <a href="#query-on-url">query filtering on URL</a>, but didn&#x27;t provide much support for a <a href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design#the-primary-index-is-used-for-selecting-granules">query filtering on UserID</a>.</p><p>Because of the similarly high cardinality of the primary key columns UserID and URL, a query that filters on the second key column <a href="#generic-exclusion-search-slow">doesn’t benefit much from the second key column being in the index</a>.</p><p>Therefore it makes sense to remove the second key column from the primary index (resulting in less memory consumption of the index) and to <a href="#multiple-primary-indexes">use multiple primary indexes</a> instead.</p><p>However if the key columns in a compound primary key have big differences in cardinality, then it is <a href="#generic-exclusion-search-fast">beneficial for queries</a> to order the primary key columns by cardinality in ascending order.</p><p>The higher the cardinality difference between the key columns is, the more the order of those columns in the key matters. We will demonstrate that in the next section.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/ClickHouse/clickhouse-docs/blob/main/docs/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-multiple.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-design"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">ClickHouse Index Design</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs-gh-pages/up/en/guides/improving-query-performance/sparse-primary-indexes/sparse-primary-indexes-cardinality"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Ordering key columns efficiently</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#secondary-key-columns-can-not-be-inefficient" class="table-of-contents__link toc-highlight">Secondary key columns can (not) be inefficient</a></li><li><a href="#generic-exclusion-search-algorithm" class="table-of-contents__link toc-highlight">Generic exclusion search algorithm</a></li><li><a href="#note-about-data-skipping-index" class="table-of-contents__link toc-highlight">Note about data skipping index</a></li><li><a href="#a-need-to-use-multiple-primary-indexes" class="table-of-contents__link toc-highlight">A need to use multiple primary indexes</a></li><li><a href="#options-for-creating-additional-primary-indexes" class="table-of-contents__link toc-highlight">Options for creating additional primary indexes</a></li><li><a href="#option-1-secondary-tables" class="table-of-contents__link toc-highlight">Option 1: Secondary Tables</a></li><li><a href="#option-2-materialized-views" class="table-of-contents__link toc-highlight">Option 2: Materialized Views</a></li><li><a href="#option-3-projections" class="table-of-contents__link toc-highlight">Option 3: Projections</a></li><li><a href="#summary" class="table-of-contents__link toc-highlight">Summary</a></li></ul></div></div></div></div></main></div></div><footer class="footer"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">ClickHouse</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://clickhouse.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Company</a></li><li class="footer__item"><a href="https://clickhouse.com/cloud/" target="_blank" rel="noopener noreferrer" class="footer__link-item">ClickHouse as a Service</a></li><li class="footer__item"><a href="https://clickhouse.com/careers/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Careers</a></li><li class="footer__item"><a href="https://clickhouse.com/learn/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Learn ClickHouse</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/ClickHouse/ClickHouse" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://clickhouse.com/blog/en/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Blog<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.meetup.com/pro/clickhouse/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Meetup<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.youtube.com/c/ClickHouseDB" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/ClickHouseDB" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://join.slack.com/t/clickhousedb/shared_invite/zt-rxm3rdrk-lIUmhLC3V8WTaL0TGxsOmg" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Policies</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://clickhouse.com/legal/trademark-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Trademark Policy</a></li><li class="footer__item"><a href="https://clickhouse.com/legal/privacy-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy Policy</a></li><li class="footer__item"><a href="https://clickhouse.com/legal/cookie-policy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Cookie Policy</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><img src="/docs-gh-pages/up/img/logo_without_text.svg" alt="ClickHouse Documentation" class="themedImage_ToTc themedImage--light_HNdA footer__logo"><img src="/docs-gh-pages/up/img/logo_without_text.svg" alt="ClickHouse Documentation" class="themedImage_ToTc themedImage--dark_i4oU footer__logo"></div><div class="footer__copyright">Copyright &copy; 2016&ndash;2022 ClickHouse, Inc. ClickHouse Docs provided under the Creative Commons CC BY-NC-SA 4.0 license. ClickHouse&reg; is a registered trademark of ClickHouse, Inc.</div></div></div></footer></div>
<script src="/docs-gh-pages/up/assets/js/runtime~main.2e91e785.js"></script>
<script src="/docs-gh-pages/up/assets/js/main.b32935ab.js"></script>
</body>
</html>